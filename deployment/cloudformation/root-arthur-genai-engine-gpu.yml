AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  ArthurResourceNamespace:
    Description: 'A unique namespace for this Arthur stack resources (e.g. arthur1). It should be between 1 and 14 characters long.'
    Type: String
    MinLength: '1'
    MaxLength: '14'
    ConstraintDescription: 'The Arthur platform resources namespace must be 1-14 characters long.'
    Default: 'arthur'
  ArthurResourceNameSuffix:
    Description: '(Optional) Name suffix for this Arthur stack resources (e.g. -prod). It should be between 0 and 5 characters long.'
    Type: String
    MinLength: '0'
    MaxLength: '5'
    ConstraintDescription: 'The Arthur platform resources name suffix must be 0-5 characters long.'
    Default: ''
  GenaiEngineContainerImageLocation:
    Description: 'The container image location for Arthur GenAI Engine'
    Type: String
    AllowedPattern: '.+'
    Default: 'arthurplatform/genai-engine-gpu'
    ConstraintDescription: 'The container image location for Arthur GenAI Engine must be specified.'
  ContainerRepositoryUsername:
    Description: '(Optional) Username for accessing the container repository'
    Type: String
    Default: ''
  ContainerRepositoryPassword:
    Description: '(Optional) Password for accessing the container repository'
    Type: String
    NoEcho: true
  OpenAIGPTModelNamesEndpointsAndKeys:
    Description: "Connection strings for OpenAI GPT model endpoints. Must be in form \"DEPLOYMENT_NAME1::OPENAI_ENDPOINT1::SECRET_KEY1,DEPLOYMENT_NAME2::OPENAI_ENDPOINT2::SECRET_KEY2\"). The endpoint URLs must end with '/'. Many may be specified."
    Type: String
    NoEcho: true
    AllowedPattern: '^(?:[^,]+::[^,]+::[^,]+(?:,[^,]+::[^,]+::[^,]+)*$)'
    ConstraintDescription: 'OpenAI GPT model deployments must be defined.'
  PostgresCredentialsUsername:
    Description: 'Username for the Postgres database'
    Type: String
    AllowedPattern: '.+'
    Default: 'arthur_admin'
  PostgresCredentialsPassword:
    Description: '(Optional) Password for the Postgres database. If not specified, one will be provisioned.'
    Type: String
    NoEcho: true
  GenaiEngineDBDatabaseName:
    Description: 'Arthur GenAI Engine database name'
    Type: String
    Default: 'arthur_genai_engine'
  GenaiEnginePostgresClientConnectionPoolSize:
    Type: Number
    Description: 'GenAI Engine Postgres client pool size'
    Default: 5
  GenaiEnginePostgresClientConnectionPoolMaxOverflow:
    Type: Number
    Description: 'GenAI Engine Postgres client connection poolmax overflow'
    Default: 15
  AlarmSNSTopicArn:
    Description: 'The ARN of the SNS topic to send the CloudWatch alarms to'
    Type: String
    AllowedPattern: 'arn:aws:sns:.+'
    ConstraintDescription: 'A valid SNS ARN must be provided for the alarm SNS topic.'
  GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold:
    Description: 'Alarm is triggered when the healthy GenAI Engine application host count drops below this number'
    Type: Number
    Default: 1
  GenaiEngineLoadBalancerTarget5xxAlarmThreshold:
    Description: 'Alarm is triggered when GenAI Engine raises more than this number of 5xx errors in a minute'
    Type: Number
    Default: 10
  GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold:
    Description: 'Alarm is triggered when the GenAI Engine average response time is longer than this number of seconds'
    Type: Number
    Default: 30
  GenaiEngineECSMemoryAlarmThreshold:
    Type: Number
    Default: 87
    Description: 'Alarm is triggered when GenAI Engine service uses this percentage of memory in a minute'
  ExistingArthurVPCId:
    Description: 'VPC to deploy Arthur stack to'
    Type: AWS::EC2::VPC::Id
    AllowedPattern: '.+'
    ConstraintDescription: 'VPC ID to deploy in must be defined'
  ExistingArthurVPCCidrBlock:
    Description: 'CIDR block of the Arthur stack VPC'
    Type: String
    AllowedPattern: '.+'
    ConstraintDescription: 'VPC CIDR block must be defined.'
  ArthurPrivateSubnets:
    Description: 'List of private subnets to use for the Arthur stack'
    Type: List<AWS::EC2::Subnet::Id>
    AllowedPattern: '.+'
    ConstraintDescription: 'Private subnets must be defined.'
  ArthurPublicSubnets:
    Description: 'List of public subnets to use for the Arthur stack'
    Type: List<AWS::EC2::Subnet::Id>
    AllowedPattern: '.+'
    ConstraintDescription: 'Public subnets must be defined.'
  PostgresBYOEndpoint:
    Description: '(Optional) Bring-your-own Postgres endpoint. If not specified, an AWS Aurora Serverless v2 cluster will be provisioned.'
    Type: String
  PostgresBYOPort:
    Description: 'The port for bring-your-own Postgres. Leave the default value if you do not have one.'
    Type: Number
    Default: 5432
  PostgresBYOSecurityGroupIDs:
    Type: CommaDelimitedList
    Description: '(Optional) Security group ID to use for the auto-provisioned Aurora Serverless v2 or the bring-your-own Postgres. If not specified, one will be provisioned.'
    Default: ''
    AllowedPattern: '^$|^sg-[0-9a-f]{8}(,sg-[0-9a-f]{8})*$|^sg-[0-9a-f]{17}(,sg-[0-9a-f]{17})*$'
    ConstraintDescription: 'Must be a comma-separated list of valid AWS security group IDs (sg- followed by 8 or 17 hexadecimal characters), or leave it empty.'
  RDSAuroraServerlessScalingConfigurationMinCapacity:
    Type: Number
    Default: 0.5
    Description: 'Aurora Serverless v2 minimum scaling capacity in ACU'
  RDSAuroraServerlessScalingConfigurationMaxCapacity:
    Type: Number
    Default: 16
    Description: 'Aurora Serverless v2 maximum scaling capacity in ACU'
  PostgresSSLCertDownloadURL:
    Type: String
    Description: 'Postgres SSL certificate download URL (must be an HTTPS endpoint)'
    AllowedPattern: 'https://.+'
    ConstraintDescription: 'A valid Postgres SSL certificate download HTTPS URL must be defined.'
    Default: 'https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem'
  GenaiEngineBYOTaskRoleIAMArn:
    Type: String
    Description: '(Optional) IAM role ARN to use for GenAI Engine ECS task role. If not specified, one will be provisioned.'
    AllowedPattern: '(arn:aws:iam:.+)?'
    ConstraintDescription: 'A valid ARN must be provided for the Arthur GenAI Engine task IAM role.'
  GenaiEngineBYOTaskExecutionRoleIAMArn:
    Type: String
    Description: '(Optional) IAM role ARN to use for GenAI Engine ECS task execution role. If not specified, one will be provisioned.'
    AllowedPattern: '(arn:aws:iam:.+)?'
    ConstraintDescription: 'A valid ARN must be provided for the Arthur GenAI Engine task execution IAM role.'
  GenaiEngineBYOEC2InstanceProfileIAMArn:
    Type: String
    Description: '(Optional) IAM instance profile ARN to use for GenAI Engine ECS cluster EC2 instances to assume. If not specified, one will be provisioned.'
    AllowedPattern: '(arn:aws:iam:.+)?'
    Default: ''
  GenaiEngineBYOLBSecurityGroupIDs:
    Type: CommaDelimitedList
    Description: '(Optional) Security group ID to use for Arthur GenAI Engine load balancer. If not specified, one will be provisioned.'
    Default: ''
    AllowedPattern: '^$|^sg-[0-9a-f]{8}(,sg-[0-9a-f]{8})*$|^sg-[0-9a-f]{17}(,sg-[0-9a-f]{17})*$'
    ConstraintDescription: 'Must be a comma-separated list of valid AWS security group IDs (sg- followed by 8 or 17 hexadecimal characters), or leave it empty.'
  GenaiEngineBYOAppSecurityGroupIDs:
    Type: CommaDelimitedList
    Description: '(Optional) Security group ID to use for Arthur GenAI Engine application. If not specified, one will be provisioned.'
    Default: ''
    AllowedPattern: '^$|^sg-[0-9a-f]{8}(,sg-[0-9a-f]{8})*$|^sg-[0-9a-f]{17}(,sg-[0-9a-f]{17})*$'
    ConstraintDescription: 'Must be a comma-separated list of valid AWS security group IDs (sg- followed by 8 or 17 hexadecimal characters), or leave it empty.'
  GenaiEngineIngressURL:
    Type: String
    Description: 'GenAI Engine application ingress DNS URL (e.g. https://arthur-genai-engine.mydomain.com)'
    AllowedPattern: 'https://.+'
    ConstraintDescription: 'A valid GenAI Engine service DNS URL must be provided.'
  GenaiEngineRoute53HostedZoneId:
    Type: String
    Description: '(Optional) The ID of the existing Route 53 hosted zone where A record of Arthur GenAI Engine DNS name is to be created'
  GenaiEngineRoute53RecordName:
    Type: String
    Description: '(Optional) The name of the Route 53 A record for Arthur GenAI Engine DNS name (e.g., arthur-genai-engine.example.com)'
  GenaiEngineLoadBalancerCertificateARN:
    Type: String
    Description: 'GenAI Engine application ingress DNS URL TLS certificate ARN'
    AllowedPattern: 'arn:aws:acm:.+'
    ConstraintDescription: 'A valid certificate ARN must be provided for GenAI Engine service ingress DNS URL.'
  GenaiEngineLoadBalancerScheme:
    Description: 'Indicate whether the load balancer is internet-facing or VPC internal'
    Type: String
    ConstraintDescription: 'Arthur GenAI Engine load balancer scheme must be defined.'
    AllowedValues:
      - 'internet-facing'
      - 'internal'
  GenaiEngineECSClusterGPUInstanceDesiredCapacity:
    Type: Number
    Default: 2
    Description: 'Desired number of GPU EC2 instances in the Arthur ECS cluster'
  GenaiEngineECSClusterGPUInstanceMaxCapacity:
    Type: Number
    Default: 4
    Description: 'Maximum number of GPU EC2 instances that can be launched in the Arthur ECS cluster (Check your G4 instance service quota to make sure you have enough capacity)'
  GenaiEngineECSClusterGPUInstanceMinCapacity:
    Type: Number
    Default: 2
    Description: 'Minimum number of GPU EC2 instances that can be launched in the Arthur ECS cluster'
  GenaiEngineECSClusterGPUInstanceType:
    Type: String
    Default: 'g4dn.2xlarge'
    Description: 'EC2 NVIDIA GPU instance type (g4dn.2xlarge is recommended)'
  GenaiEngineECSClusterGPUInstanceImageID:
    Type: String
    Description: 'EC2 GPU instance AMI ID. Look up the AMI ID for Amazon ECS-optimized AMIs (aws ssm get-parameters --names /aws/service/ecs/optimized-ami/amazon-linux-2/gpu/recommended --region <your_region>).'
    AllowedPattern: '.+'
    ConstraintDescription: 'A valid ID for ECS-optimized GPU-ready AMI must be provided. Refer to the description for GenaiEngineECSClusterGPUInstanceImageID.'
  GenaiEngineEC2TaskCPUValue:
    Type: Number
    Default: 8192
    Description: 'CPU value for AWS EC2 per GenAI Engine ECS task'
  GenaiEngineEC2TaskGPUValue:
    Type: Number
    Default: 1
    Description: 'GPU value for AWS EC2 per GenAI Engine ECS task'
  GenaiEngineEC2TaskMemoryValue:
    Type: Number
    Default: 30720
    Description: 'Memory value for AWS EC2 per GenAI Engine ECS task'
  GenaiEngineServerWorkerCount:
    Type: Number
    Default: 5
    Description: 'Number of GenAI Engine server processes to run for adjusting parallelism (5 is recommended)'
  GenaiEngineECSServiceTaskDesiredCount:
    Type: Number
    Description: 'The desired number of tasks running for GenAI Engine ECS service'
    MinValue: 2
    Default: 2
  GenaiEngineSensitiveDataCheckMaxTokenLimit:
    Type: Number
    Description: 'Max number of tokens GenAI Engine can process against LLM for sensitive data checks'
    Default: 3000
  GenaiEngineHallucinationCheckMaxTokenLimit:
    Type: Number
    Description: 'Max number of tokens GenAI Engine can process against LLM for hallucination data checks'
    Default: 6000
  GenaiEngineToxicityCheckMaxTokenLimit:
    Type: Number
    Default: 1200
    Description: 'Max number of tokens an inference can have for the toxicity rule to run. This is for managing validation latency.'
  GenaiEngineOpenAIProvider:
    Type: String
    AllowedValues:
      - 'Azure'
      - 'OpenAI'
    Default: "Azure"
    Description: 'Provider of OpenAI LLMs'
  GenaiEngineECSClusterGPUInstanceScheduledScaleInCron:
    Type: String
    Default: '0 22 * * MON-FRI'
    Description: 'Cron expression for scaling in GPU instances in UTC timezone (e.g. "0 22 * * MON-FRI")'
  GenaiEngineECSClusterGPUInstanceScheduledScaleOutCron:
    Type: String
    Default: '0 12 * * MON-FRI'
    Description: 'Cron expression for scaling out GPU instances in UTC timezone (e.g. "0 12 * * MON-FRI")'
  GenaiEngineECSClusterGPUInstanceScheduledScaleInCapacity:
    Type: Number
    Default: 2
    Description: 'Number of GPU instances to scale in to during off-peak hours'
  GenaiEngineECSClusterGPUInstanceScheduledScaleOutCapacity:
    Type: Number
    Default: 4
    Description: 'Number of GPU instances to scale out to during peak hours'
  GenaiEngineECSClusterScheduledScalingEnabled:
    Type: String
    Description: 'Enable or disable scheduled scaling of GenAI Engine ECS cluster'
    AllowedValues:
      - 'enabled'
      - 'disabled'
    Default: 'disabled'
  GenaiEngineECSClusterTaskScheduledScaleInCron:
    Type: String
    Description: 'Cron expression for scaling in GenAI Engine ECS tasks in UTC timezone (e.g. "0 22 ? * MON-FRI *")'
    Default: '0 22 ? * MON-FRI *'
  GenaiEngineECSClusterTaskScheduledScaleOutCron:
    Type: String
    Description: 'Cron expression for scaling out GenAI Engine ECS tasks in UTC timezone (e.g. "0 12 ? * MON-FRI *")'
    Default: '0 12 ? * MON-FRI *'
  GenaiEngineECSClusterGPUUtilizationScaleOutThreshold:
    Type: Number
    Default: 50
    Description: 'GPU utilization percentage threshold to trigger scale out'
  GenaiEngineECSClusterGPUUtilizationScaleInThreshold:
    Type: Number
    Default: 5
    Description: 'GPU utilization percentage threshold to trigger scale in'
  GenaiEngineECSClusterCPUUtilizationScaleOutThreshold:
    Type: Number
    Default: 50
    Description: 'CPU utilization percentage threshold to trigger scale out'
  GenaiEngineECSClusterCPUUtilizationScaleInThreshold:
    Type: Number
    Default: 10
    Description: 'CPU utilization percentage threshold to trigger scale in'
  GenaiEngineECSClusterDynamicScaleInCPUBasedEnabled:
    Type: String
    AllowedValues:
      - 'enabled'
      - 'disabled'
    Default: 'disabled'
    Description: 'Enable or disable CPU based dynamic scale-in of GenAI Engine ECS cluster'
  GenaiEngineECSClusterDynamicScaleInGPUBasedEnabled:
    Type: String
    AllowedValues:
      - 'enabled'
      - 'disabled'
    Default: 'disabled'
    Description: 'Enable or disable GPU based dynamic scale-in of GenAI Engine ECS cluster'
  GenaiEngineDynamicScaleOutCooldown:
    Type: Number
    Description: 'Cooldown period in seconds for scaling out instances'
    Default: 60
    MinValue: 60
  GenaiEngineDynamicScaleInCooldown:
    Type: Number
    Description: 'Cooldown period in seconds for scaling in instances'
    Default: 300
    MinValue: 60
  GenaiEngineECSDeploymentMaximumPercent:
    Type: Number
    Description: 'Maximum percentage of tasks that can be running during a deployment'
    Default: 100
    MinValue: 0
    MaxValue: 200
  GenaiEngineECSDeploymentMinimumHealthyPercent:
    Type: Number
    Description: 'Minimum percentage of tasks that must remain healthy during a deployment. Note: If the number of tasks is one, this should be equal to 0 or 100.'
    Default: 50
    MinValue: 0
    MaxValue: 100
  GenaiEngineECSClusterWarmPoolEnabled:
    Type: String
    Description: 'Enable or disable warm pool for GenAI Engine ECS cluster'
    AllowedValues:
      - 'enabled'
      - 'disabled'
    Default: 'disabled'
  GenaiEngineECSClusterWarmPoolMinSize:
    Type: Number
    Default: 2
    Description: 'Minimum number of instances in the GenAI Engine ECS cluster warm pool'
  GenaiEngineECSClusterWarmPoolMaxGroupPreparedCapacity:
    Type: Number
    Default: 2
    Description: 'Maximum number of instances in the GenAI Engine ECS cluster warm pool'
  GenaiEngineEstimatedInstanceWarmup:
    Type: Number
    Description: 'Estimated time in seconds for new instances to be ready to serve requests'
    Default: 120
    MinValue: 60
  GenaiEngineCacheTaskRulesCacheEnabled:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: 'Enable task rules cache'
  GenaiEngineCacheTaskRulesCacheTTL:
    Type: Number
    Default: 60
    Description: 'Task rules cache TTL in seconds'
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Minimum Required Configurations"
        Parameters:
          - ArthurResourceNamespace
          - ExistingArthurVPCId
          - ExistingArthurVPCCidrBlock
          - ArthurPrivateSubnets
          - ArthurPublicSubnets
          - AlarmSNSTopicArn
          - GenaiEngineLoadBalancerScheme
          - GenaiEngineIngressURL
          - GenaiEngineLoadBalancerCertificateARN
          - GenaiEngineECSClusterGPUInstanceImageID
          - GenaiEngineOpenAIProvider
          - OpenAIGPTModelNamesEndpointsAndKeys
      - Label:
          default: "Advanced - General"
        Parameters:
          - ArthurResourceNameSuffix
          - ContainerRepositoryUsername
          - ContainerRepositoryPassword
      - Label:
          default: 'Advanced - Database'
        Parameters:
          - PostgresBYOEndpoint
          - PostgresBYOPort
          - PostgresCredentialsUsername
          - PostgresCredentialsPassword
          - PostgresSSLCertDownloadURL
          - PostgresBYOSecurityGroupIDs
          - RDSAuroraServerlessScalingConfigurationMinCapacity
          - RDSAuroraServerlessScalingConfigurationMaxCapacity
      - Label:
          default: 'Advanced - GenAI Engine'
        Parameters:
          - GenaiEngineRoute53HostedZoneId
          - GenaiEngineRoute53RecordName
          - GenaiEngineBYOLBSecurityGroupIDs
          - GenaiEngineBYOAppSecurityGroupIDs
          - GenaiEngineContainerImageLocation
          - GenaiEngineDBDatabaseName
          - GenaiEnginePostgresClientConnectionPoolSize
          - GenaiEnginePostgresClientConnectionPoolMaxOverflow
          - GenaiEngineECSClusterGPUInstanceType
          - GenaiEngineEC2TaskCPUValue
          - GenaiEngineEC2TaskGPUValue
          - GenaiEngineEC2TaskMemoryValue
          - GenaiEngineServerWorkerCount
          - GenaiEngineECSDeploymentMaximumPercent
          - GenaiEngineECSDeploymentMinimumHealthyPercent
          - GenaiEngineCacheTaskRulesCacheEnabled
          - GenaiEngineCacheTaskRulesCacheTTL
      - Label:
          default: 'Advanced - GenAI Engine (IAM)'
        Parameters:
          - GenaiEngineBYOTaskRoleIAMArn
          - GenaiEngineBYOTaskExecutionRoleIAMArn
          - GenaiEngineBYOEC2InstanceProfileIAMArn
      - Label:
          default: 'Advanced - GenAI Engine (Dynamic Scaling)'
        Parameters:
          - GenaiEngineECSClusterGPUInstanceDesiredCapacity
          - GenaiEngineECSClusterGPUInstanceMinCapacity
          - GenaiEngineECSClusterGPUInstanceMaxCapacity
          - GenaiEngineECSServiceTaskDesiredCount
          - GenaiEngineECSClusterGPUUtilizationScaleOutThreshold
          - GenaiEngineECSClusterGPUUtilizationScaleInThreshold
          - GenaiEngineECSClusterCPUUtilizationScaleOutThreshold
          - GenaiEngineECSClusterCPUUtilizationScaleInThreshold
          - GenaiEngineECSClusterDynamicScaleInCPUBasedEnabled
          - GenaiEngineECSClusterDynamicScaleInGPUBasedEnabled
          - GenaiEngineDynamicScaleOutCooldown
          - GenaiEngineDynamicScaleInCooldown
          - GenaiEngineEstimatedInstanceWarmup
          - GenaiEngineECSClusterWarmPoolEnabled
          - GenaiEngineECSClusterWarmPoolMinSize
          - GenaiEngineECSClusterWarmPoolMaxGroupPreparedCapacity
      - Label:
          default: 'Advanced - GenAI Engine (Scheduled Scaling)'
        Parameters:
          - GenaiEngineECSClusterScheduledScalingEnabled
          - GenaiEngineECSClusterGPUInstanceScheduledScaleInCron
          - GenaiEngineECSClusterGPUInstanceScheduledScaleOutCron
          - GenaiEngineECSClusterTaskScheduledScaleInCron
          - GenaiEngineECSClusterTaskScheduledScaleOutCron
          - GenaiEngineECSClusterGPUInstanceScheduledScaleInCapacity
          - GenaiEngineECSClusterGPUInstanceScheduledScaleOutCapacity
      - Label:
          default: 'Advanced - GenAI Engine (Platform Monitoring)'
        Parameters:
          - GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold
          - GenaiEngineLoadBalancerTarget5xxAlarmThreshold
          - GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold
          - GenaiEngineECSMemoryAlarmThreshold
      - Label:
          default: 'Advanced - GenAI Engine (LLM)'
        Parameters:
          - GenaiEngineSensitiveDataCheckMaxTokenLimit
          - GenaiEngineHallucinationCheckMaxTokenLimit
          - GenaiEngineToxicityCheckMaxTokenLimit
    ParameterLabels:
      GenaiEngineContainerImageLocation:
        default: 'Arthur GenAI Engine Container Image Location'
      ContainerRepositoryUsername:
        default: 'Container Repository Username'
      ContainerRepositoryPassword:
        default: 'Container Repository Password'
      PostgresCredentialsUsername:
        default: 'Postgres Database Username'
      PostgresCredentialsPassword:
        default: 'Postgres Database Password'
      GenaiEngineDBDatabaseName:
        default: 'GenAI Engine Database Name'
      GenaiEnginePostgresClientConnectionPoolSize:
        default: 'GenAI Engine Postgres Client Pool Size'
      GenaiEnginePostgresClientConnectionPoolMaxOverflow:
        default: 'GenAI Engine Postgres Client Pool Max Overflow'
      OpenAIGPTModelNamesEndpointsAndKeys:
        default: 'OpenAI GPT Model Endpoints'
      ArthurResourceNamespace:
        default: 'Arthur Platform Resource Namespace'
      ArthurResourceNameSuffix:
        default: 'Arthur Platform Resource Name Suffix'
      GenaiEngineECSClusterGPUInstanceImageID:
        default: 'ECS Cluster EC2 GPU Instance Image ID'
      GenaiEngineECSClusterGPUInstanceType:
        default: 'ECS Cluster EC2 GPU Instance Type'
      GenaiEngineECSClusterGPUInstanceDesiredCapacity:
        default: 'ECS Cluster EC2 GPU Instance Desired Capacity'
      GenaiEngineECSClusterGPUInstanceMinCapacity:
        default: 'ECS Cluster EC2 GPU Instance Minimum Capacity'
      GenaiEngineECSClusterGPUInstanceMaxCapacity:
        default: 'ECS Cluster EC2 GPU Instance Maximum Capacity'
      GenaiEngineEC2TaskCPUValue:
        default: 'Number of CPU for EC2 GenAI Engine task'
      GenaiEngineEC2TaskGPUValue:
        default: 'Number of GPU for EC2 GenAI Engine task'
      GenaiEngineEC2TaskMemoryValue:
        default: 'Size of memory for EC2 GenAI Engine task'
      GenaiEngineServerWorkerCount:
        default: 'Number of GenAI Engine Server Workers'
      GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold:
        default: 'ALB Healthy Host Count Alarm Threshold'
      GenaiEngineLoadBalancerTarget5xxAlarmThreshold:
        default: 'ALB Target 5xx Alarm Threshold'
      GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold:
        default: 'ALB Response Time Threshold'
      GenaiEngineECSMemoryAlarmThreshold:
        default: 'ECS Memory Alarm Threshold'
      RDSAuroraServerlessScalingConfigurationMinCapacity:
        default: 'Aurora Serverless v2 Min Scaling Capacity'
      RDSAuroraServerlessScalingConfigurationMaxCapacity:
        default: 'Aurora Serverless v2 Max Scaling Capacity'
      PostgresBYOEndpoint:
        default: 'Bring-Your-Own Postgres Database Endpoint'
      PostgresBYOPort:
        default: 'Bring-Your-Own Postgres Database Port'
      PostgresSSLCertDownloadURL:
        default: 'Postgres SSL Cert Download URL'
      PostgresBYOSecurityGroupIDs:
        default: 'Bring-Your-Own Postgres Security Group IDs'
      GenaiEngineBYOTaskRoleIAMArn:
        default: 'Bring-Your-Own GenAI Engine Task IAM Role ARN'
      GenaiEngineBYOTaskExecutionRoleIAMArn:
        default: 'Bring-Your-Own GenAI Engine Task Execution IAM Role ARN'
      GenaiEngineBYOEC2InstanceProfileIAMArn:
        default: 'Bring-Your-Own GenAI Engine ECS Cluster EC2 Instance Profile IAM ARN'
      GenaiEngineBYOLBSecurityGroupIDs:
        default: 'Bring-Your-Own GenAI Engine Load Balancer Security Group IDs'
      GenaiEngineBYOAppSecurityGroupIDs:
        default: 'Bring-Your-Own GenAI Engine Application Security Group IDs'
      ExistingArthurVPCId:
        default: 'Arthur Stack VPC ID'
      ExistingArthurVPCCidrBlock:
        default: 'Arthur Stack VPC CIDR Block'
      ArthurPrivateSubnets:
        default: 'Arthur Stack Private Subnets'
      ArthurPublicSubnets:
        default: 'Arthur Stack Public Subnets'
      GenaiEngineLoadBalancerCertificateARN:
        default: 'GenAI Engine Application DNS URL TLS Certificate ARN'
      GenaiEngineLoadBalancerScheme:
        default: 'GenAI Engine Load Balancer Scheme'
      GenaiEngineIngressURL:
        default: 'GenAI Engine Application DNS URL'
      GenaiEngineRoute53HostedZoneId:
        default: 'GenAI Engine Route 53 Hosted Zone ID'
      GenaiEngineRoute53RecordName:
        default: 'GenAI Engine Route 53 Record Name'
      AlarmSNSTopicArn:
        default: 'Alarm SNS Topic ARN'
      GenaiEngineECSServiceTaskDesiredCount:
        default: 'GenAI Engine ECS Service Task Desired Count'
      GenaiEngineSensitiveDataCheckMaxTokenLimit:
        default: 'GenAI Engine Sensitive Data Check Max Token Limit'
      GenaiEngineHallucinationCheckMaxTokenLimit:
        default: 'GenAI Engine Hallucination Check Max Token Limit'
      GenaiEngineToxicityCheckMaxTokenLimit:
        default: 'GenAI Engine Toxicity Check Max Token Limit'
      GenaiEngineOpenAIProvider:
        default: 'OpenAI Service Provider'
      GenaiEngineECSClusterGPUInstanceScheduledScaleInCron:
        default: 'GenAI Engine ECS Cluster GPU Instance Scheduled Scale In Cron Expression'
      GenaiEngineECSClusterGPUInstanceScheduledScaleOutCron:
        default: 'GenAI Engine ECS Cluster GPU Instance Scheduled Scale Out Cron Expression'
      GenaiEngineECSClusterGPUInstanceScheduledScaleInCapacity:
        default: 'GenAI Engine ECS Cluster GPU Instance Scheduled Scale In Capacity'
      GenaiEngineECSClusterGPUInstanceScheduledScaleOutCapacity:
        default: 'GenAI Engine ECS Cluster GPU Instance Scheduled Scale Out Capacity'
      GenaiEngineECSClusterScheduledScalingEnabled:
        default: 'Enable scheduled scaling'
      GenaiEngineECSClusterTaskScheduledScaleInCron:
        default: 'GenAI Engine ECS Cluster Task Scheduled Scale In Cron Expression'
      GenaiEngineECSClusterTaskScheduledScaleOutCron:
        default: 'GenAI Engine ECS Cluster Task Scheduled Scale Out Cron Expression'
      GenaiEngineECSClusterGPUUtilizationScaleOutThreshold:
        default: 'GPU Utilization Scale Out Threshold'
      GenaiEngineECSClusterGPUUtilizationScaleInThreshold:
        default: 'GPU Utilization Scale In Threshold'
      GenaiEngineECSClusterCPUUtilizationScaleOutThreshold:
        default: 'CPU Utilization Scale Out Threshold'
      GenaiEngineECSClusterCPUUtilizationScaleInThreshold:
        default: 'CPU Utilization Scale In Threshold'
      GenaiEngineECSClusterDynamicScaleInCPUBasedEnabled:
        default: 'Enable CPU based dynamic scale-in of GenAI Engine ECS cluster'
      GenaiEngineECSClusterDynamicScaleInGPUBasedEnabled:
        default: 'Enable GPU based dynamic scale-in of GenAI Engine ECS cluster'
      GenaiEngineDynamicScaleOutCooldown:
        default: 'Cooldown period in seconds for scaling out instances'
      GenaiEngineDynamicScaleInCooldown:
        default: 'Cooldown period in seconds for scaling in instances'
      GenaiEngineECSDeploymentMaximumPercent:
        default: 'GenAI Engine ECS Deployment Maximum Percent'
      GenaiEngineECSDeploymentMinimumHealthyPercent:
        default: 'GenAI Engine ECS Deployment Minimum Healthy Percent'
      GenaiEngineECSClusterWarmPoolEnabled:
        default: 'Enable GenAI Engine ECS Cluster Warm Pool'
      GenaiEngineECSClusterWarmPoolMinSize:
        default: 'GenAI Engine ECS Cluster Warm Pool Min Size'
      GenaiEngineECSClusterWarmPoolMaxGroupPreparedCapacity:
        default: 'GenAI Engine ECS Cluster Warm Pool Max Group Prepared Capacity'
      GenaiEngineEstimatedInstanceWarmup:
        default: 'Estimated time in seconds for new instances to be ready to serve requests'
      GenaiEngineCacheTaskRulesCacheEnabled:
        default: 'Enable task rules cache'
      GenaiEngineCacheTaskRulesCacheTTL:
        default: 'Task rules cache TTL in seconds'
Conditions:
  ContainerRepositoryCredentialRequired:
    !Not [ !Equals [ !Ref ContainerRepositoryUsername, '' ] ]
Resources:
  CoreVPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ExistingVPCId: !Ref ExistingArthurVPCId
        ExistingVPCCidrBlock: !Ref ExistingArthurVPCCidrBlock
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-vpc.yml"
  CoreSecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        VPCId: !GetAtt [ CoreVPCStack, Outputs.VPCIdOutput ]
        VPCCidrBlock: !GetAtt [ CoreVPCStack, Outputs.VPCCidrBlockOutput ]
        PostgresBYOSecurityGroupIDs: !Join [ ",", !Ref PostgresBYOSecurityGroupIDs ]
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-security-groups.yml"
  CoreSecretsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        ContainerRepositoryUsername: !Ref ContainerRepositoryUsername
        ContainerRepositoryPassword: !Ref ContainerRepositoryPassword
        PostgresUsername: !Ref PostgresCredentialsUsername
        PostgresPassword: !Ref PostgresCredentialsPassword
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-secrets-manager.yml"
  CoreRDSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        ArthurBringYourOwnDBEndpoint: !Ref PostgresBYOEndpoint
        ArthurBringYourOwnDBPort: !Ref PostgresBYOPort
        ArthurDBSecretArn: !GetAtt [ CoreSecretsStack, Outputs.PostgresCredentialsSecretOutput ]
        ArthurRDSSecurityGroupIds: !GetAtt [ CoreSecurityGroupStack, Outputs.ArthurRDSSecurityGroupsOutput ]
        ArthurRDSPrivateSubnets: !Join [ ',', !Ref ArthurPrivateSubnets ]
        ArthurRDSDatabaseName: !Ref GenaiEngineDBDatabaseName
        ArthurRDSScalingConfigurationMinCapacity: !Ref RDSAuroraServerlessScalingConfigurationMinCapacity
        ArthurRDSScalingConfigurationMaxCapacity: !Ref RDSAuroraServerlessScalingConfigurationMaxCapacity
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-rds.yml"
  CoreECSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-ecs.yml"
  GenaiEngineSecretsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        OpenAIEmbeddingModelNamesEndpointsAndKeys: 'none'
        OpenAIGPTModelNamesEndpointsAndKeys: !Ref OpenAIGPTModelNamesEndpointsAndKeys
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-secrets-manager.yml"
  GenaiEngineIAMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        GenaiEngineBYOTaskRoleIAMArn: !Ref GenaiEngineBYOTaskRoleIAMArn
        GenaiEngineBYOTaskExecutionRoleIAMArn: !Ref GenaiEngineBYOTaskExecutionRoleIAMArn
        GenaiEngineBYOEC2InstanceProfileIAMArn: !Ref GenaiEngineBYOEC2InstanceProfileIAMArn
        GenaiEngineSecretArns: !Join
          - ','
          - - !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineOpenAIGPTModelNamesEndpointsAndKeysSecretOutput ]
            - !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAPIKeySecretOutput ]
            - !GetAtt [ CoreSecretsStack, Outputs.PostgresCredentialsSecretOutput ]
            - !GetAtt [ CoreSecretsStack, Outputs.ContainerRepositoryCredentialsSecretOutput ]
            - !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAppKeySecretOutput ]
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-iam.yml"
  GenaiEngineSecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        VPCId: !GetAtt [ CoreVPCStack, Outputs.VPCIdOutput ]
        VPCCidrBlock: !GetAtt [ CoreVPCStack, Outputs.VPCCidrBlockOutput ]
        GenaiEngineBYOLBSecurityGroupIDs: !Join [ ",", !Ref GenaiEngineBYOLBSecurityGroupIDs ]
        GenaiEngineBYOAppSecurityGroupIDs: !Join [ ",", !Ref GenaiEngineBYOAppSecurityGroupIDs ]
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-security-groups.yml"
  GenaiEngineECSGPUTaskDefinitionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        GenaiEngineECSTaskRoleARN: !GetAtt [ GenaiEngineIAMStack, Outputs.GenaiEngineTaskRoleOutput ]
        GenaiEngineECSTaskExecutionRoleARN: !GetAtt [ GenaiEngineIAMStack, Outputs.GenaiEngineTaskExecutionRoleOutput ]
        GenaiEngineVersion: 'REPLACE_ME_GENAI_ENGINE_VERSION'
        GenaiEnginePostgresUrl: !GetAtt [ CoreRDSStack, Outputs.RDSInstanceAddressOutput ]
        GenaiEnginePostgresPort: !GetAtt [ CoreRDSStack, Outputs.RDSInstancePortOutput ]
        GenaiEnginePostgresDatabaseName: !Ref GenaiEngineDBDatabaseName
        GenaiEnginePostgresClientConnectionPoolSize: !Ref GenaiEnginePostgresClientConnectionPoolSize
        GenaiEnginePostgresClientConnectionPoolMaxOverflow: !Ref GenaiEnginePostgresClientConnectionPoolMaxOverflow
        GenaiEngineIngressURL: !Ref GenaiEngineIngressURL
        GenaiEnginePostgresSSLCertDownloadURL: !Ref PostgresSSLCertDownloadURL
        GenaiEngineContainerImageLocation: !Ref GenaiEngineContainerImageLocation
        ContainerRepositoryCredentialRequired: !If [ ContainerRepositoryCredentialRequired, 'true', 'false' ]
        ContainerRepositoryCredentialsSecretARN: !GetAtt [ CoreSecretsStack, Outputs.ContainerRepositoryCredentialsSecretOutput ]
        GenaiEngineSecretAPIKeyARN: !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAPIKeySecretOutput ]
        GenaiEngineAppSecretKeyARN: !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAppKeySecretOutput ]
        GenaiEngineSecretOpenAIGPTModelNamesEndpointsKeysARN: !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineOpenAIGPTModelNamesEndpointsAndKeysSecretOutput ]
        GenaiEngineSecretPostgresARN: !GetAtt [ CoreSecretsStack, Outputs.PostgresCredentialsSecretOutput ]
        GenaiEngineSensitiveDataCheckMaxTokenLimit: !Ref GenaiEngineSensitiveDataCheckMaxTokenLimit
        GenaiEngineHallucinationCheckMaxTokenLimit: !Ref GenaiEngineHallucinationCheckMaxTokenLimit
        GenaiEngineToxicityCheckMaxTokenLimit: !Ref GenaiEngineToxicityCheckMaxTokenLimit
        GenaiEngineEC2TaskCPUValue: !Ref GenaiEngineEC2TaskCPUValue
        GenaiEngineEC2TaskGPUValue: !Ref GenaiEngineEC2TaskGPUValue
        GenaiEngineEC2TaskMemoryValue: !Ref GenaiEngineEC2TaskMemoryValue
        GenaiEngineServerWorkerCount: !Ref GenaiEngineServerWorkerCount
        GenaiEngineOpenAIProvider: !Ref GenaiEngineOpenAIProvider
        GenaiEngineCacheTaskRulesCacheEnabled: !Ref GenaiEngineCacheTaskRulesCacheEnabled
        GenaiEngineCacheTaskRulesCacheTTL: !Ref GenaiEngineCacheTaskRulesCacheTTL
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-ecs-task-definition-gpu.yml"
  GenaiEngineLBStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        GenaiEngineLoadBalancerSecurityGroupIDs: !GetAtt [ GenaiEngineSecurityGroupStack, Outputs.GenaiEngineLBSecurityGroupsOutput ]
        GenaiEngineLoadBalancerSubnetIDs: !Join [ ',', !Ref ArthurPublicSubnets ]
        GenaiEngineLoadBalancerCertificateARN: !Ref GenaiEngineLoadBalancerCertificateARN
        GenaiEngineLoadBalancerScheme: !Ref GenaiEngineLoadBalancerScheme
        GenaiEngineVPCId: !Ref ExistingArthurVPCId
        GenaiEngineRoute53HostedZoneId: !Ref GenaiEngineRoute53HostedZoneId
        GenaiEngineRoute53RecordName: !Ref GenaiEngineRoute53RecordName
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-lb.yml"
  GenaiEngineECSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        ArthurECSClusterName: !GetAtt [ CoreECSStack, Outputs.ArthurECSClusterNameOutput ]
        GenaiEngineLBTargetGroupARN: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBTargetGroupOutput ]
        GenaiEngineECSSecurityGroups: !GetAtt [ GenaiEngineSecurityGroupStack, Outputs.GenaiEngineAppSecurityGroupsOutput ]
        GenaiEngineECSServiceSubnetIDs: !Join [ ',', !Ref ArthurPrivateSubnets ]
        GenaiEngineECSTaskDefinitionARN: !GetAtt [ GenaiEngineECSGPUTaskDefinitionStack, Outputs.GenaiEngineECSGPUTaskDefinitionOutput ]
        GenaiEngineECSServiceTaskDesiredCount: !Ref GenaiEngineECSServiceTaskDesiredCount
        GenaiEngineECSClusterGPUInstanceMaxCapacity: !Ref GenaiEngineECSClusterGPUInstanceMaxCapacity
        GenaiEngineECSClusterGPUInstanceMinCapacity: !Ref GenaiEngineECSClusterGPUInstanceMinCapacity
        GenaiEngineECSClusterGPUInstanceDesiredCapacity: !Ref GenaiEngineECSClusterGPUInstanceDesiredCapacity
        GenaiEngineECSClusterGPUInstanceType: !Ref GenaiEngineECSClusterGPUInstanceType
        GenaiEngineECSClusterGPUInstanceImageID: !Ref GenaiEngineECSClusterGPUInstanceImageID
        GenaiEngineEC2InstanceProfileIAMArn: !GetAtt [ GenaiEngineIAMStack, Outputs.GenaiEngineEC2InstanceProfileOutput ]
        GenaiEngineECSClusterGPUUtilizationScaleOutThreshold: !Ref GenaiEngineECSClusterGPUUtilizationScaleOutThreshold
        GenaiEngineECSClusterGPUUtilizationScaleInThreshold: !Ref GenaiEngineECSClusterGPUUtilizationScaleInThreshold
        GenaiEngineECSClusterCPUUtilizationScaleOutThreshold: !Ref GenaiEngineECSClusterCPUUtilizationScaleOutThreshold
        GenaiEngineECSClusterCPUUtilizationScaleInThreshold: !Ref GenaiEngineECSClusterCPUUtilizationScaleInThreshold
        GenaiEngineECSClusterGPUInstanceScheduledScaleInCron: !Ref GenaiEngineECSClusterGPUInstanceScheduledScaleInCron
        GenaiEngineECSClusterGPUInstanceScheduledScaleOutCron: !Ref GenaiEngineECSClusterGPUInstanceScheduledScaleOutCron
        GenaiEngineECSClusterGPUInstanceScheduledScaleInCapacity: !Ref GenaiEngineECSClusterGPUInstanceScheduledScaleInCapacity
        GenaiEngineECSClusterGPUInstanceScheduledScaleOutCapacity: !Ref GenaiEngineECSClusterGPUInstanceScheduledScaleOutCapacity
        GenaiEngineECSClusterScheduledScalingEnabled: !Ref GenaiEngineECSClusterScheduledScalingEnabled
        GenaiEngineECSClusterTaskScheduledScaleInCron: !Ref GenaiEngineECSClusterTaskScheduledScaleInCron
        GenaiEngineECSClusterTaskScheduledScaleOutCron: !Ref GenaiEngineECSClusterTaskScheduledScaleOutCron
        GenaiEngineTaskScalingLambdaRoleARN: !GetAtt [ GenaiEngineIAMStack, Outputs.GenaiEngineTaskScalingLambdaRoleOutput ]
        GenaiEngineDynamicScaleOutCooldown: !Ref GenaiEngineDynamicScaleOutCooldown
        GenaiEngineDynamicScaleInCooldown: !Ref GenaiEngineDynamicScaleInCooldown
        GenaiEngineECSClusterDynamicScaleInCPUBasedEnabled: !Ref GenaiEngineECSClusterDynamicScaleInCPUBasedEnabled
        GenaiEngineECSClusterDynamicScaleInGPUBasedEnabled: !Ref GenaiEngineECSClusterDynamicScaleInGPUBasedEnabled
        GenaiEngineECSDeploymentMaximumPercent: !Ref GenaiEngineECSDeploymentMaximumPercent
        GenaiEngineECSDeploymentMinimumHealthyPercent: !Ref GenaiEngineECSDeploymentMinimumHealthyPercent
        GenaiEngineECSClusterWarmPoolEnabled: !Ref GenaiEngineECSClusterWarmPoolEnabled
        GenaiEngineECSClusterWarmPoolMinSize: !Ref GenaiEngineECSClusterWarmPoolMinSize
        GenaiEngineECSClusterWarmPoolMaxGroupPreparedCapacity: !Ref GenaiEngineECSClusterWarmPoolMaxGroupPreparedCapacity
        GenaiEngineEstimatedInstanceWarmup: !Ref GenaiEngineEstimatedInstanceWarmup
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-ecs-gpu.yml"
  GenaiEngineCloudwatchStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        GenaiEngineLBTargetGroupArnSuffix: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBTargetGroupFullNameOutput ]
        GenaiEngineLBArnSuffix: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBFullNameOutput ]
        ArthurECSClusterName: !GetAtt [ CoreECSStack, Outputs.ArthurECSClusterNameOutput ]
        GenaiEngineECSServiceName: !GetAtt [ GenaiEngineECSStack, Outputs.GenaiEngineECSServiceNameOutput ]
        GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold: !Ref GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold
        GenaiEngineLoadBalancerTarget5xxAlarmThreshold: !Ref GenaiEngineLoadBalancerTarget5xxAlarmThreshold
        GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold: !Ref GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold
        GenaiEngineECSMemoryAlarmThreshold: !Ref GenaiEngineECSMemoryAlarmThreshold
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-cloudwatch-alarms.yml"
  GenaiEngineCloudwatchDashboardStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        ArthurECSClusterName: !GetAtt [ CoreECSStack, Outputs.ArthurECSClusterNameOutput ]
        GenaiEngineECSServiceName: !GetAtt [ GenaiEngineECSStack, Outputs.GenaiEngineECSServiceNameOutput ]
        GenaiEngineLBTargetGroupFullName: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBTargetGroupFullNameOutput ]
        GenaiEngineLoadBalancerFullName: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBFullNameOutput ]
        GenaiEngineRDSClusterIdentifier: !GetAtt [ CoreRDSStack, Outputs.RDSClusterIdentifierOutput ]
      TemplateURL: !Sub "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-cloudwatch-dashboard.yml"
