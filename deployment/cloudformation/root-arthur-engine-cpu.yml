AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  ArthurResourceNamespace:
    Description: 'A unique namespace for this Arthur stack resources (e.g. arthur1). It should be between 1 and 14 characters long.'
    Type: String
    MinLength: '1'
    MaxLength: '14'
    ConstraintDescription: 'The Arthur platform resources namespace must be 1-14 characters long.'
    Default: 'arthur'
  ArthurResourceNameSuffix:
    Description: '(Optional) Name suffix for this Arthur stack resources (e.g. -prod). It should be between 0 and 5 characters long.'
    Type: String
    MinLength: '0'
    MaxLength: '5'
    ConstraintDescription: 'The Arthur platform resources name suffix must be 0-5 characters long.'
    Default: ''
  GenaiEngineContainerImageLocation:
    Description: 'The container image location for Arthur GenAI Engine'
    Type: String
    AllowedPattern: '.+'
    Default: 'arthurplatform/genai-engine-cpu'
    ConstraintDescription: 'The container image location for Arthur GenAI Engine must be specified.'
  MLEngineContainerImageLocation:
    Description: 'The container image location for Arthur ML Engine'
    Type: String
    AllowedPattern: '.+'
    Default: 'arthurplatform/ml-engine'
    ConstraintDescription: 'The container image location for Arthur ML Engine must be specified.'
  ContainerRepositoryUsername:
    Description: '(Optional) Username for accessing the container repository'
    Type: String
    Default: ''
  ContainerRepositoryPassword:
    Description: '(Optional) Password for accessing the container repository'
    Type: String
    NoEcho: true
  OpenAIGPTModelNamesEndpointsAndKeys:
    Description: "Connection strings for OpenAI GPT model endpoints. Must be in form \"DEPLOYMENT_NAME1::OPENAI_ENDPOINT1::SECRET_KEY1,DEPLOYMENT_NAME2::OPENAI_ENDPOINT2::SECRET_KEY2\". The endpoint URLs must end with '/' (e.g. https://api.openai.com/v1/). Many may be specified."
    Type: String
    NoEcho: true
    AllowedPattern: '.+'
    ConstraintDescription: 'OpenAI GPT model deployments must be defined.'
  PostgresCredentialsUsername:
    Description: 'Username for the Postgres database'
    Type: String
    AllowedPattern: '.+'
    Default: 'arthur_admin'
  PostgresCredentialsPassword:
    Description: '(Optional) Password for the Postgres database. If not specified, one will be provisioned.'
    Type: String
    NoEcho: true
  GenaiEngineDBDatabaseName:
    Description: 'Arthur GenAI Engine database name'
    Type: String
    Default: 'arthur_genai_engine'
  GenaiEnginePostgresClientConnectionPoolSize:
    Type: Number
    Description: 'GenAI Engine Postgres client pool size'
    Default: 5
  GenaiEnginePostgresClientConnectionPoolMaxOverflow:
    Type: Number
    Description: 'GenAI Engine Postgres client connection poolmax overflow'
    Default: 15
  ArthurApiHost:
    Description: 'URL for the Arthur Platform'
    Type: String
    AllowedPattern: 'https://.+'
    Default: 'https://platform.arthur.ai'
  MLEngineClientId:
    Description: 'Client ID for the ML Engine'
    Type: String
    AllowedPattern: '.+'
  MLEngineClientSecret:
    Description: 'Client Secret for the ML Engine'
    Type: String
    NoEcho: true
    AllowedPattern: '.+'
  MLEngineVersion:
    Description: 'Version tag for the ML Engine'
    Type: String
    Default: 'latest'
    AllowedPattern: '.+'
    ConstraintDescription: 'ML Engine version must be specified.'
  AlarmSNSTopicArn:
    Description: 'The ARN of the SNS topic to send the CloudWatch alarms to'
    Type: String
    AllowedPattern: 'arn:aws:sns:.+'
    ConstraintDescription: 'A valid SNS ARN must be provided for the alarm SNS topic.'
  GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold:
    Description: 'Alarm is triggered when the healthy GenAI Engine application host count drops below this number'
    Type: Number
    Default: 1
  GenaiEngineLoadBalancerTarget5xxAlarmThreshold:
    Description: 'Alarm is triggered when GenAI Engine raises more than this number of 5xx errors in a minute'
    Type: Number
    Default: 10
  GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold:
    Description: 'Alarm is triggered when the GenAI Engine average response time is longer than this number of seconds'
    Type: Number
    Default: 30
  GenaiEngineECSMemoryAlarmThreshold:
    Type: Number
    Default: 87
    Description: 'Alarm is triggered when GenAI Engine service uses this percentage of memory in a minute'
  MLEngineECSMemoryAlarmThreshold:
    Type: Number
    Default: 80
    Description: 'Alarm is triggered when ML Engine service uses this percentage of memory in a minute'
  MLEngineECSCPUAlarmThreshold:
    Type: Number
    Default: 80
    Description: 'Alarm is triggered when ML Engine service uses this percentage of CPU in a minute'
  ExistingArthurVPCId:
    Description: 'VPC to deploy Arthur stack to'
    Type: AWS::EC2::VPC::Id
    AllowedPattern: '.+'
    ConstraintDescription: 'VPC ID to deploy in must be defined'
  ExistingArthurVPCCidrBlock:
    Description: 'CIDR block of the Arthur stack VPC'
    Type: String
    AllowedPattern: '.+'
    ConstraintDescription: 'VPC CIDR block must be defined.'
  ArthurPrivateSubnets:
    Description: 'List of private subnets to use for the Arthur stack'
    Type: List<AWS::EC2::Subnet::Id>
    AllowedPattern: '.+'
    ConstraintDescription: 'Private subnets must be defined.'
  ArthurPublicSubnets:
    Description: 'List of public subnets to use for the Arthur stack'
    Type: List<AWS::EC2::Subnet::Id>
    AllowedPattern: '.+'
    ConstraintDescription: 'Public subnets must be defined.'
  PostgresBYOEndpoint:
    Description: '(Optional) Bring-your-own Postgres endpoint. If not specified, an AWS Aurora Serverless v2 cluster will be provisioned.'
    Type: String
  PostgresBYOPort:
    Description: 'The port for bring-your-own Postgres. Leave the default value if you do not have one.'
    Type: Number
    Default: 5432
  PostgresBYOSecurityGroupIDs:
    Type: CommaDelimitedList
    Description: '(Optional) Security group ID to use for the auto-provisioned Aurora Serverless v2 or the bring-your-own Postgres. If not specified, one will be provisioned.'
    Default: ''
    AllowedPattern: '^$|^sg-[0-9a-f]{8}(,sg-[0-9a-f]{8})*$|^sg-[0-9a-f]{17}(,sg-[0-9a-f]{17})*$'
    ConstraintDescription: 'Must be a comma-separated list of valid AWS security group IDs (sg- followed by 8 or 17 hexadecimal characters), or leave it empty.'
  RDSAuroraServerlessScalingConfigurationMinCapacity:
    Type: Number
    Default: 0.5
    Description: 'Aurora Serverless v2 minimum scaling capacity in ACU'
  RDSAuroraServerlessScalingConfigurationMaxCapacity:
    Type: Number
    Default: 16
    Description: 'Aurora Serverless v2 maximum scaling capacity in ACU'
  PostgresSSLCertDownloadURL:
    Type: String
    Description: 'Postgres SSL certificate download URL (must be an HTTPS endpoint)'
    AllowedPattern: 'https://.+'
    ConstraintDescription: 'A valid Postgres SSL certificate download HTTPS URL must be defined.'
    Default: 'https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem'
  GenaiEngineBYOTaskRoleIAMArn:
    Type: String
    Description: '(Optional) IAM Role ARN to use for GenAI Engine ECS task role. If not specified, one will be provisioned.'
    AllowedPattern: '(arn:aws:iam:.+)?'
    ConstraintDescription: 'A valid ARN must be provided for the Arthur GenAI Engine task IAM role.'
  GenaiEngineBYOTaskExecutionRoleIAMArn:
    Type: String
    Description: '(Optional) IAM Role ARN to use for GenAI Engine ECS task execution role. If not specified, one will be provisioned.'
    AllowedPattern: '(arn:aws:iam:.+)?'
    ConstraintDescription: 'A valid ARN must be provided for the Arthur GenAI Engine task execution IAM role.'
  GenaiEngineBYOLBSecurityGroupIDs:
    Type: CommaDelimitedList
    Description: '(Optional) Security group ID to use for Arthur GenAI Engine load balancer. If not specified, one will be provisioned.'
    Default: ''
    AllowedPattern: '^$|^sg-[0-9a-f]{8}(,sg-[0-9a-f]{8})*$|^sg-[0-9a-f]{17}(,sg-[0-9a-f]{17})*$'
    ConstraintDescription: 'Must be a comma-separated list of valid AWS security group IDs (sg- followed by 8 or 17 hexadecimal characters), or leave it empty.'
  GenaiEngineBYOAppSecurityGroupIDs:
    Type: CommaDelimitedList
    Description: '(Optional) Security group ID to use for Arthur GenAI Engine application. If not specified, one will be provisioned.'
    Default: ''
    AllowedPattern: '^$|^sg-[0-9a-f]{8}(,sg-[0-9a-f]{8})*$|^sg-[0-9a-f]{17}(,sg-[0-9a-f]{17})*$'
    ConstraintDescription: 'Must be a comma-separated list of valid AWS security group IDs (sg- followed by 8 or 17 hexadecimal characters), or leave it empty.'
  GenaiEngineIngressURL:
    Type: String
    Description: 'GenAI Engine application ingress DNS URL (e.g. https://arthur-genai-engine.mydomain.com)'
    AllowedPattern: 'https://.+'
    ConstraintDescription: 'A valid GenAI Engine service DNS URL must be provided.'
  GenaiEngineRoute53HostedZoneId:
    Type: String
    Description: '(Optional) The ID of the existing Route 53 hosted zone that contains the A record of GenAI Engine DNS to update. Only required when you want the A record of Arthur GenAI Engine DNS to be created.'
  GenaiEngineRoute53RecordName:
    Type: String
    Description: '(Optional) The name of the Route 53 A record of GenAI Engine DNS to create (e.g., arthur-genai-engine.example.com)'
  GenaiEngineLoadBalancerCertificateARN:
    Type: String
    Description: 'GenAI Engine application ingress DNS URL TLS certificate ARN'
    AllowedPattern: 'arn:aws:acm:.+'
    ConstraintDescription: 'A valid certificate ARN must be provided for GenAI Engine service ingress DNS URL.'
  GenaiEngineLoadBalancerScheme:
    Description: 'Indicate whether the load balancer is internet-facing or VPC internal'
    Type: String
    ConstraintDescription: 'Arthur GenAI Engine load balancer scheme must be defined.'
    AllowedValues:
      - 'internet-facing'
      - 'internal'
  GenaiEngineFargateTaskCPUValue:
    Type: Number
    Default: 8192
    Description: 'CPU value for AWS Fargate per GenAI Engine ECS task'
  GenaiEngineFargateTaskMemoryValue:
    Type: Number
    Default: 16384
    Description: 'Memory value for AWS Fargate per GenAI Engine ECS task'
  GenaiEngineServerWorkerCount:
    Type: Number
    Default: 1
    Description: 'Number of GenAI Engine server processes to run for adjusting parallelism'
  GenaiEngineECSScaleCPUTargetValue:
    Type: Number
    Description: 'CPU target value for triggering GenAI Engine ECS service autoscaling'
    Default: 50
  GenaiEngineECSScaleInCooldownInSecs:
    Type: Number
    Description: 'Scale-in cooldown time in seconds for GenAI Engine ECS autoscaling'
    Default: 300
  GenaiEngineECSScaleOutCooldownInSecs:
    Type: Number
    Description: 'Scale-out cooldown time in seconds for GenAI Engine ECS autoscaling'
    Default: 30
  GenaiEngineECSAutoscalingMaxCapacity:
    Type: Number
    Description: 'The maximum number of tasks allowed for GenAI Engine ECS service autoscaling'
    Default: 10
  GenaiEngineECSAutoscalingMinCapacity:
    Type: Number
    Description: 'The minimum number of tasks allowed for GenAI Engine ECS service autoscaling'
    Default: 2
  GenaiEngineECSServiceTaskDesiredCount:
    Type: Number
    Description: 'The desired number of tasks running for GenAI Engine ECS service'
    Default: 2
  GenaiEngineSensitiveDataCheckMaxTokenLimit:
    Type: Number
    Description: 'Max number of tokens GenAI Engine can process against LLM for sensitive data checks'
    Default: 3000
  GenaiEngineHallucinationCheckMaxTokenLimit:
    Type: Number
    Description: 'Max number of tokens GenAI Engine can process against LLM for hallucination data checks'
    Default: 6000
  GenaiEngineToxicityCheckMaxTokenLimit:
    Type: Number
    Default: 1200
    Description: 'Max number of tokens an inference can have for the toxicity rule to run. This is for managing validation latency.'
  GenaiEngineOpenAIProvider:
    Type: String
    AllowedValues:
      - 'Azure'
      - 'OpenAI'
    Default: "Azure"
    Description: 'Provider of OpenAI LLMs'
  GenaiEngineCacheTaskRulesCacheEnabled:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: 'Enable task rules cache'
  GenaiEngineCacheTaskRulesCacheTTL:
    Type: Number
    Default: 60
    Description: 'Task rules cache TTL in seconds'
  MLEngineBYOTaskRoleIAMArn:
    Type: String
    Description: '(Optional) IAM Role ARN to use for ML Engine ECS task role. If not specified, one will be provisioned.'
    AllowedPattern: '(arn:aws:iam:.+)?'
    ConstraintDescription: 'A valid ARN must be provided for the Arthur ML Engine task IAM role.'
  MLEngineBYOTaskExecutionRoleIAMArn:
    Type: String
    Description: '(Optional) IAM Role ARN to use for ML Engine ECS task execution role. If not specified, one will be provisioned.'
    AllowedPattern: '(arn:aws:iam:.+)?'
    ConstraintDescription: 'A valid ARN must be provided for the Arthur ML Engine task execution IAM role.'
  MLEngineBYOAppSecurityGroupIDs:
    Type: CommaDelimitedList
    Description: '(Optional) Security group ID to use for Arthur ML Engine application. If not specified, one will be provisioned.'
    Default: ''
    AllowedPattern: '^$|^sg-[0-9a-f]{8}(,sg-[0-9a-f]{8})*$|^sg-[0-9a-f]{17}(,sg-[0-9a-f]{17})*$'
    ConstraintDescription: 'Must be a comma-separated list of valid AWS security group IDs (sg- followed by 8 or 17 hexadecimal characters), or leave it empty.'
  MLEngineECSScaleCPUTargetValue:
    Type: Number
    Description: 'CPU target value for triggering ML Engine ECS service autoscaling'
    Default: 50
  MLEngineECSScaleMemoryTargetValue:
    Type: Number
    Description: 'CPU target value for triggering ML Engine ECS service autoscaling'
    Default: 25
  MLEngineECSScaleInCooldownInSecs:
    Type: Number
    Description: 'Scale-in cooldown time in seconds for ML Engine ECS autoscaling'
    Default: 300
  MLEngineECSScaleOutCooldownInSecs:
    Type: Number
    Description: 'Scale-out cooldown time in seconds for ML Engine ECS autoscaling'
    Default: 30
  MLEngineECSAutoscalingMaxCapacity:
    Type: Number
    Description: 'The maximum number of tasks allowed for ML Engine ECS service autoscaling'
    Default: 10
  MLEngineECSAutoscalingMinCapacity:
    Type: Number
    Description: 'The minimum number of tasks allowed for ML Engine ECS service autoscaling'
    Default: 2
  MLEngineECSServiceTaskDesiredCount:
    Type: Number
    Description: 'The desired number of tasks running for ML Engine ECS service'
    Default: 2
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Minimum Required Configurations'
        Parameters:
          - ArthurResourceNamespace
          - ExistingArthurVPCId
          - ExistingArthurVPCCidrBlock
          - ArthurPrivateSubnets
          - ArthurPublicSubnets
          - AlarmSNSTopicArn
          - GenaiEngineLoadBalancerScheme
          - GenaiEngineIngressURL
          - GenaiEngineLoadBalancerCertificateARN
          - GenaiEngineOpenAIProvider
          - OpenAIGPTModelNamesEndpointsAndKeys
          - ArthurApiHost
          - MLEngineClientId
          - MLEngineClientSecret
      - Label:
          default: 'Advanced - General'
        Parameters:
          - ArthurResourceNameSuffix
          - ContainerRepositoryUsername
          - ContainerRepositoryPassword
      - Label:
          default: 'Advanced - Database'
        Parameters:
          - PostgresBYOEndpoint
          - PostgresBYOPort
          - PostgresCredentialsUsername
          - PostgresCredentialsPassword
          - PostgresSSLCertDownloadURL
          - PostgresBYOSecurityGroupIDs
          - RDSAuroraServerlessScalingConfigurationMinCapacity
          - RDSAuroraServerlessScalingConfigurationMaxCapacity
      - Label:
          default: 'Advanced GenAI Engine'
        Parameters:
          - GenaiEngineRoute53HostedZoneId
          - GenaiEngineRoute53RecordName
          - GenaiEngineBYOLBSecurityGroupIDs
          - GenaiEngineBYOAppSecurityGroupIDs
          - GenaiEngineContainerImageLocation
          - GenaiEngineDBDatabaseName
          - GenaiEnginePostgresClientConnectionPoolSize
          - GenaiEnginePostgresClientConnectionPoolMaxOverflow
          - GenaiEngineFargateTaskCPUValue
          - GenaiEngineFargateTaskMemoryValue
          - GenaiEngineServerWorkerCount
          - GenaiEngineCacheTaskRulesCacheEnabled
          - GenaiEngineCacheTaskRulesCacheTTL
      - Label:
          default: 'Advanced GenAI Engine (IAM)'
        Parameters:
          - GenaiEngineBYOTaskRoleIAMArn
          - GenaiEngineBYOTaskExecutionRoleIAMArn
      - Label:
          default: 'Advanced GenAI Engine (Scalability)'
        Parameters:
          - GenaiEngineECSServiceTaskDesiredCount
          - GenaiEngineECSAutoscalingMinCapacity
          - GenaiEngineECSAutoscalingMaxCapacity
          - GenaiEngineECSScaleCPUTargetValue
          - GenaiEngineECSScaleInCooldownInSecs
          - GenaiEngineECSScaleOutCooldownInSecs
      - Label:
          default: 'Advanced GenAI Engine (Platform Monitoring)'
        Parameters:
          - GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold
          - GenaiEngineLoadBalancerTarget5xxAlarmThreshold
          - GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold
          - GenaiEngineECSMemoryAlarmThreshold
      - Label:
          default: 'Advanced GenAI Engine (LLM)'
        Parameters:
          - GenaiEngineSensitiveDataCheckMaxTokenLimit
          - GenaiEngineHallucinationCheckMaxTokenLimit
          - GenaiEngineToxicityCheckMaxTokenLimit
      - Label:
          default: 'Advanced ML Engine'
        Parameters:
          - MLEngineVersion
          - MLEngineClientId
          - MLEngineClientSecret
          - MLEngineContainerImageLocation
          - MLEngineBYOAppSecurityGroupIDs
      - Label:
          default: 'Advanced ML Engine (IAM)'
        Parameters:
          - MLEngineBYOTaskRoleIAMArn
          - MLEngineBYOTaskExecutionRoleIAMArn
      - Label:
          default: 'Advanced ML Engine (Scalability)'
        Parameters:
          - MLEngineECSServiceTaskDesiredCount
          - MLEngineECSAutoscalingMinCapacity
          - MLEngineECSAutoscalingMaxCapacity
          - MLEngineECSScaleCPUTargetValue
          - MLEngineECSScaleMemoryTargetValue
          - MLEngineECSScaleInCooldownInSecs
          - MLEngineECSScaleOutCooldownInSecs
      - Label:
          default: 'Advanced ML Engine (Platform Monitoring)'
        Parameters:
          - MLEngineECSCPUAlarmThreshold
          - MLEngineECSMemoryAlarmThreshold
    ParameterLabels:
      GenaiEngineContainerImageLocation:
        default: 'Arthur GenAI Engine Container Image Location'
      ContainerRepositoryUsername:
        default: 'Container Repository Username'
      ContainerRepositoryPassword:
        default: 'Container Repository Password'
      PostgresCredentialsUsername:
        default: 'Postgres Database Username'
      PostgresCredentialsPassword:
        default: 'Postgres Database Password'
      GenaiEngineDBDatabaseName:
        default: 'GenAI Engine Database Name'
      GenaiEnginePostgresClientConnectionPoolSize:
        default: 'GenAI Engine Postgres Client Pool Size'
      GenaiEnginePostgresClientConnectionPoolMaxOverflow:
        default: 'GenAI Engine Postgres Client Pool Max Overflow'
      OpenAIGPTModelNamesEndpointsAndKeys:
        default: 'OpenAI GPT Model Endpoints'
      ArthurResourceNamespace:
        default: 'Arthur Platform Resource Namespace'
      ArthurResourceNameSuffix:
        default: 'Arthur Platform Resource Name Suffix'
      GenaiEngineFargateTaskCPUValue:
        default: 'Number of CPU for Fargate GenAI Engine task'
      GenaiEngineFargateTaskMemoryValue:
        default: 'Size of memory for Fargate GenAI Engine task'
      GenaiEngineServerWorkerCount:
        default: 'Number of GenAI Engine Server Workers'
      GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold:
        default: 'ALB Healthy Host Count Alarm Threshold'
      GenaiEngineLoadBalancerTarget5xxAlarmThreshold:
        default: 'ALB Target 5xx Alarm Threshold'
      GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold:
        default: 'ALB Response Time Threshold'
      GenaiEngineECSMemoryAlarmThreshold:
        default: 'ECS Memory Alarm Threshold'
      RDSAuroraServerlessScalingConfigurationMinCapacity:
        default: 'Aurora Serverless v2 Min Scaling Capacity'
      RDSAuroraServerlessScalingConfigurationMaxCapacity:
        default: 'Aurora Serverless v2 Max Scaling Capacity'
      PostgresBYOEndpoint:
        default: 'Bring-Your-Own Postgres Database Endpoint'
      PostgresBYOPort:
        default: 'Bring-Your-Own Postgres Database Port'
      PostgresSSLCertDownloadURL:
        default: 'Postgres SSL Cert Download URL'
      PostgresBYOSecurityGroupIDs:
        default: 'Bring-Your-Own Postgres Security Group IDs'
      GenaiEngineBYOTaskRoleIAMArn:
        default: 'Bring-Your-Own GenAI Engine Task Role'
      GenaiEngineBYOTaskExecutionRoleIAMArn:
        default: 'Bring-Your-Own GenAI Engine Task Execution Role'
      GenaiEngineBYOLBSecurityGroupIDs:
        default: 'Bring-Your-Own GenAI Engine Load Balancer Security Group IDs'
      GenaiEngineBYOAppSecurityGroupIDs:
        default: 'Bring-Your-Own GenAI Engine Application Security Group IDs'
      ExistingArthurVPCId:
        default: 'Arthur Stack VPC ID'
      ExistingArthurVPCCidrBlock:
        default: 'Arthur Stack VPC CIDR Block'
      ArthurPrivateSubnets:
        default: 'Arthur Stack Private Subnets'
      ArthurPublicSubnets:
        default: 'Arthur Stack Public Subnets'
      GenaiEngineLoadBalancerCertificateARN:
        default: 'GenAI Engine Application DNS URL TLS Certificate ARN'
      GenaiEngineLoadBalancerScheme:
        default: 'GenAI Engine Load Balancer Scheme'
      GenaiEngineIngressURL:
        default: 'GenAI Engine Application DNS URL'
      GenaiEngineRoute53HostedZoneId:
        default: 'GenAI Engine Route 53 Hosted Zone ID'
      GenaiEngineRoute53RecordName:
        default: 'GenAI Engine Route 53 Record Name'
      AlarmSNSTopicArn:
        default: 'Alarm SNS Topic ARN'
      GenaiEngineECSScaleCPUTargetValue:
        default: 'GenAI Engine ECS Scale CPU Target Value'
      GenaiEngineECSScaleInCooldownInSecs:
        default: 'GenAI Engine ECS Scale-in Cooldown in Seconds'
      GenaiEngineECSScaleOutCooldownInSecs:
        default: 'GenAI Engine ECS Scale-out Cooldown in Seconds'
      GenaiEngineECSAutoscalingMaxCapacity:
        default: 'GenAI Engine ECS Autoscaling Max Capacity'
      GenaiEngineECSAutoscalingMinCapacity:
        default: 'GenAI Engine ECS Autoscaling Min Capacity'
      GenaiEngineECSServiceTaskDesiredCount:
        default: 'GenAI Engine ECS Service Task Desired Count'
      GenaiEngineSensitiveDataCheckMaxTokenLimit:
        default: 'GenAI Engine Sensitive Data Check Max Token Limit'
      GenaiEngineHallucinationCheckMaxTokenLimit:
        default: 'GenAI Engine Hallucination Check Max Token Limit'
      GenaiEngineToxicityCheckMaxTokenLimit:
        default: 'GenAI Engine Toxicity Check Max Token Limit'
      GenaiEngineOpenAIProvider:
        default: 'OpenAI Service Provider'
      GenaiEngineCacheTaskRulesCacheEnabled:
        default: 'Enable task rules cache'
      GenaiEngineCacheTaskRulesCacheTTL:
        default: 'Task rules cache TTL in seconds'
      MLEngineVersion:
        default: 'ML Engine Version'
      MLEngineClientId:
        default: 'ML Engine Client ID'
      MLEngineClientSecret:
        default: 'ML Engine Client Secret'
      MLEngineContainerImageLocation:
        default: 'Arthur ML Engine Container Image Location'
      MLEngineECSCPUAlarmThreshold:
        default: 'ML Engine ECS CPU Alarm Threshold'
      MLEngineECSMemoryAlarmThreshold:
        default: 'ML Engine ECS Memory Alarm Threshold'
      MLEngineECSScaleCPUTargetValue:
        default: 'ML Engine ECS Scale CPU Target Value'
      MLEngineECSScaleMemoryTargetValue:
        default: 'ML Engine ECS Scale Memory Target Value'
      MLEngineECSScaleInCooldownInSecs:
        default: 'ML Engine ECS Scale-in Cooldown in Seconds'
      MLEngineECSScaleOutCooldownInSecs:
        default: 'ML Engine ECS Scale-out Cooldown in Seconds'
      MLEngineECSAutoscalingMaxCapacity:
        default: 'ML Engine ECS Autoscaling Max Capacity'
      MLEngineECSAutoscalingMinCapacity:
        default: 'ML Engine ECS Autoscaling Min Capacity'
      MLEngineECSServiceTaskDesiredCount:
        default: 'ML Engine ECS Service Task Desired Count'
      MLEngineBYOTaskRoleIAMArn:
        default: 'Bring-Your-Own ML Engine Task Role'
      MLEngineBYOTaskExecutionRoleIAMArn:
        default: 'Bring-Your-Own ML Engine Task Execution Role'
      MLEngineBYOAppSecurityGroupIDs:
        default: 'Bring-Your-Own ML Engine Application Security Group IDs'
      ArthurApiHost:
        default: 'Arthur Platform URL'
Conditions:
  ContainerRepositoryCredentialRequired:
    !Not [ !Equals [ !Ref ContainerRepositoryUsername, '' ] ]
Resources:
  CoreVPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ExistingVPCId: !Ref ExistingArthurVPCId
        ExistingVPCCidrBlock: !Ref ExistingArthurVPCCidrBlock
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-vpc.yml"
  CoreSecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        VPCId: !GetAtt [ CoreVPCStack, Outputs.VPCIdOutput ]
        VPCCidrBlock: !GetAtt [ CoreVPCStack, Outputs.VPCCidrBlockOutput ]
        PostgresBYOSecurityGroupIDs: !Join [ ",", !Ref PostgresBYOSecurityGroupIDs ]
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-security-groups.yml"
  CoreSecretsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        ContainerRepositoryUsername: !Ref ContainerRepositoryUsername
        ContainerRepositoryPassword: !Ref ContainerRepositoryPassword
        PostgresUsername: !Ref PostgresCredentialsUsername
        PostgresPassword: !Ref PostgresCredentialsPassword
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-secrets-manager.yml"
  CoreRDSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        ArthurBringYourOwnDBEndpoint: !Ref PostgresBYOEndpoint
        ArthurBringYourOwnDBPort: !Ref PostgresBYOPort
        ArthurDBSecretArn: !GetAtt [ CoreSecretsStack, Outputs.PostgresCredentialsSecretOutput ]
        ArthurRDSSecurityGroupIds: !GetAtt [ CoreSecurityGroupStack, Outputs.ArthurRDSSecurityGroupsOutput ]
        ArthurRDSPrivateSubnets: !Join [ ',', !Ref ArthurPrivateSubnets ]
        ArthurRDSDatabaseName: !Ref GenaiEngineDBDatabaseName
        ArthurRDSScalingConfigurationMinCapacity: !Ref RDSAuroraServerlessScalingConfigurationMinCapacity
        ArthurRDSScalingConfigurationMaxCapacity: !Ref RDSAuroraServerlessScalingConfigurationMaxCapacity
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-rds.yml"
  CoreECSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/core/arthur-core-ecs.yml"
  GenaiEngineSecretsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        OpenAIEmbeddingModelNamesEndpointsAndKeys: 'none'
        OpenAIGPTModelNamesEndpointsAndKeys: !Ref OpenAIGPTModelNamesEndpointsAndKeys
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-secrets-manager.yml"
  MLEngineSecretsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        MLEngineClientId: !Ref MLEngineClientId
        MLEngineClientSecret: !Ref MLEngineClientSecret
      TemplateURL: "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/ml-engine/arthur-ml-engine-secrets-manager.yml"
  GenaiEngineIAMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        GenaiEngineBYOTaskRoleIAMArn: !Ref GenaiEngineBYOTaskRoleIAMArn
        GenaiEngineBYOTaskExecutionRoleIAMArn: !Ref GenaiEngineBYOTaskExecutionRoleIAMArn
        GenaiEngineSecretArns: !Join
          - ','
          - - !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineOpenAIEmbeddingModelNamesEndpointsAndKeysSecretOutput ]
            - !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineOpenAIGPTModelNamesEndpointsAndKeysSecretOutput ]
            - !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAPIKeySecretOutput ]
            - !GetAtt [ CoreSecretsStack, Outputs.PostgresCredentialsSecretOutput ]
            - !GetAtt [ CoreSecretsStack, Outputs.ContainerRepositoryCredentialsSecretOutput ]
            - !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAppKeySecretOutput ]
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-iam.yml"
  MLEngineIAMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        MLEngineBYOTaskRoleIAMArn: !Ref MLEngineBYOTaskRoleIAMArn
        MLEngineBYOTaskExecutionRoleIAMArn: !Ref MLEngineBYOTaskExecutionRoleIAMArn
        MLEngineSecretArns: !Join
          - ','
          - - !GetAtt [ CoreSecretsStack, Outputs.ContainerRepositoryCredentialsSecretOutput ]
            - !GetAtt [ MLEngineSecretsStack, Outputs.MLEngineClientCredentialsSecretOutput ]
            - !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAPIKeySecretOutput ]
      TemplateURL: "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/ml-engine/arthur-ml-engine-iam.yml"
  GenaiEngineSecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        VPCId: !GetAtt [ CoreVPCStack, Outputs.VPCIdOutput ]
        VPCCidrBlock: !GetAtt [ CoreVPCStack, Outputs.VPCCidrBlockOutput ]
        GenaiEngineBYOLBSecurityGroupIDs: !Join [ ",", !Ref GenaiEngineBYOLBSecurityGroupIDs ]
        GenaiEngineBYOAppSecurityGroupIDs: !Join [ ",", !Ref GenaiEngineBYOAppSecurityGroupIDs ]
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-security-groups.yml"
  MLEngineSecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        VPCId: !GetAtt [ CoreVPCStack, Outputs.VPCIdOutput ]
        VPCCidrBlock: !GetAtt [ CoreVPCStack, Outputs.VPCCidrBlockOutput ]
        MLEngineBYOAppSecurityGroupIDs: !Join [ ",", !Ref MLEngineBYOAppSecurityGroupIDs ]
      TemplateURL: "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/ml-engine/arthur-ml-engine-security-groups.yml"
  GenaiEngineECSTaskDefinitionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        GenaiEngineECSTaskRoleARN: !GetAtt [ GenaiEngineIAMStack, Outputs.GenaiEngineTaskRoleOutput ]
        GenaiEngineECSTaskExecutionRoleARN: !GetAtt [ GenaiEngineIAMStack, Outputs.GenaiEngineTaskExecutionRoleOutput ]
        GenaiEngineVersion: 'REPLACE_ME_GENAI_ENGINE_VERSION'
        GenaiEnginePostgresUrl: !GetAtt [ CoreRDSStack, Outputs.RDSInstanceAddressOutput ]
        GenaiEnginePostgresPort: !GetAtt [ CoreRDSStack, Outputs.RDSInstancePortOutput ]
        GenaiEnginePostgresDatabaseName: !Ref GenaiEngineDBDatabaseName
        GenaiEnginePostgresClientConnectionPoolSize: !Ref GenaiEnginePostgresClientConnectionPoolSize
        GenaiEnginePostgresClientConnectionPoolMaxOverflow: !Ref GenaiEnginePostgresClientConnectionPoolMaxOverflow
        GenaiEngineIngressURL: !Ref GenaiEngineIngressURL
        GenaiEnginePostgresSSLCertDownloadURL: !Ref PostgresSSLCertDownloadURL
        GenaiEngineContainerImageLocation: !Ref GenaiEngineContainerImageLocation
        ContainerRepositoryCredentialRequired: !If [ ContainerRepositoryCredentialRequired, 'true', 'false' ]
        ContainerRepositoryCredentialsSecretARN: !GetAtt [ CoreSecretsStack, Outputs.ContainerRepositoryCredentialsSecretOutput ]
        GenaiEngineSecretAPIKeyARN: !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAPIKeySecretOutput ]
        GenaiEngineAppSecretKeyARN: !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAppKeySecretOutput ]
        GenaiEngineSecretOpenAIGPTModelNamesEndpointsKeysARN: !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineOpenAIGPTModelNamesEndpointsAndKeysSecretOutput ]
        GenaiEngineSecretOpenAIEmbeddingModelNamesEndpointsKeysARN: !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineOpenAIEmbeddingModelNamesEndpointsAndKeysSecretOutput ]
        GenaiEngineSecretPostgresARN: !GetAtt [ CoreSecretsStack, Outputs.PostgresCredentialsSecretOutput ]
        GenaiEngineAPIOnlyModeEnabled: 'enabled'
        GenaiEngineSensitiveDataCheckMaxTokenLimit: !Ref GenaiEngineSensitiveDataCheckMaxTokenLimit
        GenaiEngineHallucinationCheckMaxTokenLimit: !Ref GenaiEngineHallucinationCheckMaxTokenLimit
        GenaiEngineToxicityCheckMaxTokenLimit: !Ref GenaiEngineToxicityCheckMaxTokenLimit
        GenaiEngineFargateTaskCPUValue: !Ref GenaiEngineFargateTaskCPUValue
        GenaiEngineFargateTaskMemoryValue: !Ref GenaiEngineFargateTaskMemoryValue
        GenaiEngineServerWorkerCount: !Ref GenaiEngineServerWorkerCount
        GenaiEngineOpenAIProvider: !Ref GenaiEngineOpenAIProvider
        GenaiEngineCacheTaskRulesCacheEnabled: !Ref GenaiEngineCacheTaskRulesCacheEnabled
        GenaiEngineCacheTaskRulesCacheTTL: !Ref GenaiEngineCacheTaskRulesCacheTTL
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-ecs-task-definition.yml"
  MLEngineECSTaskDefinitionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        MLEngineECSTaskRoleARN: !GetAtt [ MLEngineIAMStack, Outputs.MLEngineTaskRoleOutput ]
        MLEngineECSTaskExecutionRoleARN: !GetAtt [ MLEngineIAMStack, Outputs.MLEngineTaskExecutionRoleOutput ]
        MLEngineVersion: !Ref MLEngineVersion
        MLEngineContainerImageLocation: !Ref MLEngineContainerImageLocation
        ContainerRepositoryCredentialRequired: !If [ ContainerRepositoryCredentialRequired, 'true', 'false' ]
        ContainerRepositoryCredentialsSecretARN: !GetAtt [ CoreSecretsStack, Outputs.ContainerRepositoryCredentialsSecretOutput ]
        MLEngineArthurApiHost: !Ref ArthurApiHost
        MLEngineClientCredentialsSecretARN: !GetAtt [ MLEngineSecretsStack, Outputs.MLEngineClientCredentialsSecretOutput ]
        GenaiEngineInternalAPIKeySecretARN: !GetAtt [ GenaiEngineSecretsStack, Outputs.GenaiEngineAPIKeySecretOutput ]
        GenaiEngineInternalIngressHost: !Ref GenaiEngineIngressURL
      TemplateURL: "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/ml-engine/arthur-ml-engine-ecs-task-definition.yml"
  GenaiEngineLBStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        GenaiEngineLoadBalancerSecurityGroupIDs: !GetAtt [ GenaiEngineSecurityGroupStack, Outputs.GenaiEngineLBSecurityGroupsOutput ]
        GenaiEngineLoadBalancerSubnetIDs: !Join [ ',', !Ref ArthurPublicSubnets ]
        GenaiEngineLoadBalancerCertificateARN: !Ref GenaiEngineLoadBalancerCertificateARN
        GenaiEngineLoadBalancerScheme: !Ref GenaiEngineLoadBalancerScheme
        GenaiEngineVPCId: !Ref ExistingArthurVPCId
        GenaiEngineRoute53HostedZoneId: !Ref GenaiEngineRoute53HostedZoneId
        GenaiEngineRoute53RecordName: !Ref GenaiEngineRoute53RecordName
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-lb.yml"
  GenaiEngineECSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurECSClusterName: !GetAtt [ CoreECSStack, Outputs.ArthurECSClusterNameOutput ]
        GenaiEngineLBTargetGroupARN: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBTargetGroupOutput ]
        GenaiEngineECSSecurityGroups: !GetAtt [ GenaiEngineSecurityGroupStack, Outputs.GenaiEngineAppSecurityGroupsOutput ]
        GenaiEngineECSServiceSubnetIDs: !Join [ ',', !Ref ArthurPrivateSubnets ]
        GenaiEngineECSTaskDefinitionARN: !GetAtt [ GenaiEngineECSTaskDefinitionStack, Outputs.GenaiEngineECSTaskDefinitionOutput ]
        GenaiEngineECSServiceTaskDesiredCount: !Ref GenaiEngineECSServiceTaskDesiredCount
        GenaiEngineECSAutoscalingMinCapacity: !Ref GenaiEngineECSAutoscalingMinCapacity
        GenaiEngineECSAutoscalingMaxCapacity: !Ref GenaiEngineECSAutoscalingMaxCapacity
        GenaiEngineECSScaleCPUTargetValue: !Ref GenaiEngineECSScaleCPUTargetValue
        GenaiEngineECSScaleInCooldownInSecs: !Ref GenaiEngineECSScaleInCooldownInSecs
        GenaiEngineECSScaleOutCooldownInSecs: !Ref GenaiEngineECSScaleOutCooldownInSecs
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-ecs.yml"
  MLEngineECSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurECSClusterName: !GetAtt [ CoreECSStack, Outputs.ArthurECSClusterNameOutput ]
        MLEngineECSSecurityGroups: !GetAtt [ MLEngineSecurityGroupStack, Outputs.MLEngineAppSecurityGroupsOutput ]
        MLEngineECSServiceSubnetIDs: !Join [ ',', !Ref ArthurPrivateSubnets ]
        MLEngineECSTaskDefinitionARN: !GetAtt [ MLEngineECSTaskDefinitionStack, Outputs.MLEngineECSTaskDefinitionOutput ]
        MLEngineECSScaleCPUTargetValue: !Ref MLEngineECSScaleCPUTargetValue
        MLEngineECSScaleMemoryTargetValue: !Ref MLEngineECSScaleMemoryTargetValue
        MLEngineECSScaleInCooldownInSecs: !Ref MLEngineECSScaleInCooldownInSecs
        MLEngineECSScaleOutCooldownInSecs: !Ref MLEngineECSScaleOutCooldownInSecs
        MLEngineECSAutoscalingMaxCapacity: !Ref MLEngineECSAutoscalingMaxCapacity
        MLEngineECSAutoscalingMinCapacity: !Ref MLEngineECSAutoscalingMinCapacity
        MLEngineECSServiceTaskDesiredCount: !Ref MLEngineECSServiceTaskDesiredCount
      TemplateURL: "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/ml-engine/arthur-ml-engine-ecs.yml"
  GenaiEngineCloudwatchStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        GenaiEngineLBTargetGroupArnSuffix: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBTargetGroupFullNameOutput ]
        GenaiEngineLBArnSuffix: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBFullNameOutput ]
        ArthurECSClusterName: !GetAtt [ CoreECSStack, Outputs.ArthurECSClusterNameOutput ]
        GenaiEngineECSServiceName: !GetAtt [ GenaiEngineECSStack, Outputs.GenaiEngineECSServiceNameOutput ]
        GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold: !Ref GenaiEngineLoadBalancerHealthyHostCountAlarmThreshold
        GenaiEngineLoadBalancerTarget5xxAlarmThreshold: !Ref GenaiEngineLoadBalancerTarget5xxAlarmThreshold
        GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold: !Ref GenaiEngineLoadBalancerTargetResponseTimeAlarmThreshold
        GenaiEngineECSMemoryAlarmThreshold: !Ref GenaiEngineECSMemoryAlarmThreshold
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-cloudwatch-alarms.yml"
  MLEngineCloudwatchStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        AlarmSNSTopicArn: !Ref AlarmSNSTopicArn
        ArthurECSClusterName: !GetAtt [ CoreECSStack, Outputs.ArthurECSClusterNameOutput ]
        MLEngineECSServiceName: !GetAtt [ MLEngineECSStack, Outputs.MLEngineECSServiceNameOutput ]
        MLEngineECSCPUAlarmThreshold: !Ref MLEngineECSCPUAlarmThreshold
        MLEngineECSMemoryAlarmThreshold: !Ref MLEngineECSMemoryAlarmThreshold
      TemplateURL: "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/ml-engine/arthur-ml-engine-cloudwatch-alarms.yml"
  GenaiEngineCloudwatchDashboardStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        ArthurECSClusterName: !GetAtt [ CoreECSStack, Outputs.ArthurECSClusterNameOutput ]
        GenaiEngineECSServiceName: !GetAtt [ GenaiEngineECSStack, Outputs.GenaiEngineECSServiceNameOutput ]
        GenaiEngineLBTargetGroupFullName: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBTargetGroupFullNameOutput ]
        GenaiEngineLoadBalancerFullName: !GetAtt [ GenaiEngineLBStack, Outputs.GenaiEngineLBFullNameOutput ]
        GenaiEngineRDSClusterIdentifier: !GetAtt [ CoreRDSStack, Outputs.RDSClusterIdentifierOutput ]
      TemplateURL:  "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/genai-engine/arthur-genai-engine-cloudwatch-dashboard.yml"
  MLEngineCloudwatchDashboardStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        ArthurResourceNamespace: !Ref ArthurResourceNamespace
        ArthurResourceNameSuffix: !Ref ArthurResourceNameSuffix
        ArthurECSClusterName: !GetAtt [ CoreECSStack, Outputs.ArthurECSClusterNameOutput ]
        MLEngineECSServiceName: !GetAtt [ MLEngineECSStack, Outputs.MLEngineECSServiceNameOutput ]
      TemplateURL: "https://arthur-cft.s3.us-east-2.amazonaws.com/arthur-engine/templates/REPLACE_ME_GENAI_ENGINE_VERSION/ml-engine/arthur-ml-engine-cloudwatch-dashboard.yml"
