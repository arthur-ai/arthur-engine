{{/*
Auto-generate secrets for GenAI Engine encryption if they don't already exist.
This uses Helm's lookup function to check for existing secrets in the namespace.
If the secret exists, it preserves the existing value.
If the secret doesn't exist, it generates a new random Fernet key.

This ensures that:
1. First install: Secrets are auto-generated
2. Upgrades: Existing secrets are preserved (critical for data access)
3. No manual secret management required unless desired

Note: The key should be a base64-encoded 32-byte Fernet key.
*/}}
{{- $secretStoreKeySecret := lookup "v1" "Secret" .Release.Namespace .Values.genaiEngineSecretStoreKeyName }}
{{- $secretStoreKey := "" }}
{{- if $secretStoreKeySecret }}
  {{/* Preserve existing secret key */}}
  {{- $secretStoreKey = index $secretStoreKeySecret.data "key" }}
{{- else }}
  {{/* Generate new random Fernet key (32 bytes, base64 encoded) */}}
  {{- $secretStoreKey = randAlphaNum 32 | b64enc }}
{{- end }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.genaiEngineSecretStoreKeyName }}
  labels:
    app: arthur-genai-engine
    {{- include "arthur-genai-engine.labels" . | nindent 4 }}
type: Opaque
data:
  key: {{ $secretStoreKey }}
