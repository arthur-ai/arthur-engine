{{/*
Auto-generate secrets for GenAI Engine encryption if they don't already exist.
This uses Helm's lookup function to check for existing secrets in the namespace.
If the secret exists, it preserves the existing value.
If the secret doesn't exist, it generates a new random 32-character alphanumeric string.

This ensures that:
1. First install: Secrets are auto-generated
2. Upgrades: Existing secrets are preserved (critical for data access)
3. No manual secret management required unless desired
*/}}
{{- $secretStoreKeySecret := lookup "v1" "Secret" .Release.Namespace .Values.genaiEngineSecretStoreKeyName }}
{{- $secretStoreKey := "" }}
{{- if $secretStoreKeySecret }}
  {{/* Preserve existing secret key */}}
  {{- $secretStoreKey = index $secretStoreKeySecret.data "key" }}
{{- else }}
  {{/* Generate new random key (32 chars, base64 encoded) */}}
  {{- $secretStoreKey = randAlphaNum 32 | b64enc }}
{{- end }}

{{- $secretStoreSaltSecret := lookup "v1" "Secret" .Release.Namespace .Values.genaiEngineSecretStoreSaltName }}
{{- $secretStoreSalt := "" }}
{{- if $secretStoreSaltSecret }}
  {{/* Preserve existing secret salt */}}
  {{- $secretStoreSalt = index $secretStoreSaltSecret.data "salt" }}
{{- else }}
  {{/* Generate new random salt (32 chars, base64 encoded) */}}
  {{- $secretStoreSalt = randAlphaNum 32 | b64enc }}
{{- end }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.genaiEngineSecretStoreKeyName }}
  labels:
    app: arthur-genai-engine
    {{- include "arthur-genai-engine.labels" . | nindent 4 }}
type: Opaque
data:
  key: {{ $secretStoreKey }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.genaiEngineSecretStoreSaltName }}
  labels:
    app: arthur-genai-engine
    {{- include "arthur-genai-engine.labels" . | nindent 4 }}
type: Opaque
data:
  salt: {{ $secretStoreSalt }}
